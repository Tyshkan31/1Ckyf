
Функция ОтправитьЗапросКСерверу(ТекстЗапроса) Экспорт 
    
    Попытка
        Сообщить("Используем COM для HTTP запроса...");
        
        HTTPЗапрос = Новый COMОбъект("WinHttp.WinHttpRequest.5.1");
        URL = "https://wriest-rita-homological.ngrok-free.dev/classify";
        JSONТекст = "{""text"": """ + ТекстЗапроса + """}";
        
        HTTPЗапрос.Open("POST", URL, Ложь);
        HTTPЗапрос.SetRequestHeader("Content-Type", "application/json");
        HTTPЗапрос.Send(JSONТекст);
        
        HTTPЗапрос.WaitForResponse();
        
        КодОтвета = HTTPЗапрос.Status;
        Сообщить("Код ответа: " + КодОтвета);
        
        // ПОЛУЧАЕМ ОТВЕТ КАК БИНАРНЫЕ ДАННЫЕ
        ОтветБинарный = HTTPЗапрос.ResponseBody;
        
        // Преобразуем бинарные данные в строку с правильной кодировкой
        ОтветТекст = БинарныеДанныеВСтрокуUTF8(ОтветБинарный);
        
        Сообщить("Ответ: " + ОтветТекст);
        
        Возврат ОтветТекст; 
    Исключение
        Сообщить("Ошибка: " + ОписаниеОшибки());
        Возврат Неопределено;
    КонецПопытки;
    
КонецФункции    

Функция ПолучитьСообщениеGemini(ТекстЗапроса) Экспорт
	Возврат Интеграции.ПолучитьСообщениеGemini(ТекстЗапроса);
КонецФункции

Функция СоздатьОбращениеВБазе(ТекстЗапроса, ОтветСервера, Источник, ЧатИД = Неопределено) Экспорт
    
    Попытка
        // Разбор JSON ответа
        Данные = РазобратьJSONПравильно(ОтветСервера);
        Если Данные = Неопределено Тогда
            Возврат Ложь;
        КонецЕсли;

        // Создаем новое обращение
        НовоеОбращение = Справочники.Обращения.СоздатьЭлемент();

        // Заполняем основные поля
        НовоеОбращение.ТекстОбращения = ТекстЗапроса;
        
        // Заполняем тип (category)
        Категория = НРег(СокрЛП(Данные.category));
        Если Категория = "жалоба" Тогда
            НовоеОбращение.Тип = Перечисления.ТипыОбращений.Жалоба;
        ИначеЕсли Категория = "техническая ошибка" Тогда
            НовоеОбращение.Тип = Перечисления.ТипыОбращений.ТехническаяОшибка;
        ИначеЕсли Категория = "вопрос по оплате" Тогда
            НовоеОбращение.Тип = Перечисления.ТипыОбращений.ВопросПоОплате;
        ИначеЕсли Категория = "предложение" Тогда
            НовоеОбращение.Тип = Перечисления.ТипыОбращений.Предложение;
        Иначе
            НовоеОбращение.Тип = Перечисления.ТипыОбращений.Прочее;
        КонецЕсли;
        
        // Заполняем статус
        НовоеОбращение.Статус = Перечисления.СтатусыОбращения.Новое;
        
        // Заполняем приоритет (priority)
        Приоритет = НРег(СокрЛП(Данные.priority));
        Если Приоритет = "высокий" Тогда
            НовоеОбращение.Приоритет = Перечисления.ПриоритетыОбращения.Высокий;
        ИначеЕсли Приоритет = "срочный" Тогда
            НовоеОбращение.Приоритет = Перечисления.ПриоритетыОбращения.Срочный;
        ИначеЕсли Приоритет = "средний" Тогда
            НовоеОбращение.Приоритет = Перечисления.ПриоритетыОбращения.Средний;
        ИначеЕсли Приоритет = "низкий" Тогда
            НовоеОбращение.Приоритет = Перечисления.ПриоритетыОбращения.Низкий;
        Иначе
            НовоеОбращение.Приоритет = Перечисления.ПриоритетыОбращения.Средний;
        КонецЕсли;
        
        // Заполняем тональность (tone)
        Тон = НРег(СокрЛП(Данные.tone));
        Если Тон = "нейтральная" Тогда
            НовоеОбращение.Тональность = Перечисления.ТональностьОбращений.Нейтральная;
        ИначеЕсли Тон = "позитивная" Тогда
            НовоеОбращение.Тональность = Перечисления.ТональностьОбращений.Позитивная;
        ИначеЕсли Тон = "негативная" Тогда
            НовоеОбращение.Тональность = Перечисления.ТональностьОбращений.Негативная;
        Иначе
            НовоеОбращение.Тональность = Перечисления.ТональностьОбращений.Нейтральная;
        КонецЕсли;
        
        // Заполняем системные поля (исправлено - убрана Дата)
        НовоеОбращение.Автор = ПользователиИнформационнойБазы.ТекущийПользователь();
        НовоеОбращение.Источник = Источник;
        // Дата = ТекущаяДата(); // Убрали если нет такого поля
        
        // Создаем наименование
        КороткийТекст = ТекстЗапроса;
        Если СтрДлина(КороткийТекст) > 50 Тогда
            КороткийТекст = Лев(КороткийТекст, 50) + "...";
        КонецЕсли;
        НовоеОбращение.Наименование = КороткийТекст;
		НовоеОбращение.ДатаСоздания = ТекущаяДатаСеанса(); 
		НовоеОбращение.ЧатИД = ЧатИД;
		
		ЗаписатьСостояниеОбращенийНаСервере(НовоеОбращение);  
		ЗаполнитьИсполнителя(НовоеОбращение);
        // Сохраняем
        НовоеОбращение.Записать();
        
        Сообщить("Обращение успешно создано!");
        Возврат Истина;
        
    Исключение
        Сообщить("Ошибка при создании обращения: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
КонецФункции

//Вызывать при записи справочника обращения
Процедура ЗаписатьСостояниеОбращенийНаСервере(Объект) Экспорт  
	
	ДатаСеанса = ТекущаяДатаСеанса();
	Объект.ДатаОбновления = ДатаСеанса;
	СтруктураОбращения = Новый Структура("Обращение, Сотрудник, Статус, СлужебныйКомментарий");
	СтруктураОбращения.Обращение = Объект.Ссылка;
	СтруктураОбращения.Статус = Объект.Статус;

	НовоеОбращение = Ложь;
	Если Объект.Статус = Перечисления.СтатусыОбращения.Новое Тогда 
		НовоеОбращение = Истина;			
	КонецЕсли;
	
	Если НовоеОбращение Тогда  	
		СтруктураОбращения.Сотрудник = Справочники.Пользователи.СистемныйПользователь;
		СтруктураОбращения.СлужебныйКомментарий = СтрШаблон("Создано новое обращение. Автор обращения: %1", Объект.Автор); 
	Иначе
		Отбор = Новый Структура;
		Отбор.Вставить("Обращение", Объект.Ссылка);
		ПоследнееОбращение = РегистрыСведений.СостояниеОбращений;
		ТекВерсияОбращения = ПоследнееОбращение.ПолучитьПоследнее(ДатаСеанса, Отбор);
		
		Если ТекВерсияОбращения.СтатусРесурс = Объект.Статус Тогда 
			Возврат;
		Иначе  
			СтруктураОбращения.Сотрудник = Объект.Исполнитель;
			Если Объект.Статус = Перечисления.СтатусыОбращения.Новое Тогда  
				СтруктураОбращения.СлужебныйКомментарий = СтрШаблон("Создано новое обращение. Автор обращения: %1", Объект.Автор); 	
			ИначеЕсли Объект.Статус = Перечисления.СтатусыОбращения.ВРаботе Тогда 
				СтруктураОбращения.СлужебныйКомментарий = СтрШаблон("Обращение принято в работу. Исполнитель: %1", Объект.Исполнитель); 
			ИначеЕсли Объект.Статус = Перечисления.СтатусыОбращения.ОжидаетКлиента Тогда 
				СтруктураОбращения.СлужебныйКомментарий = СтрШаблон("Обращение передано клиенту: %1", Объект.Автор);
			ИначеЕсли Объект.Статус = Перечисления.СтатусыОбращения.Закрыто Тогда 	
				СтруктураОбращения.СлужебныйКомментарий = СтрШаблон("Обращение закрыто"); 
			КонецЕсли; 
			
			Решение = 0;
			Реакция = 0;
			ПовторнаяРеакция = 0;
			
			Если ТекВерсияОбращения.СтатусРесурс = Перечисления.СтатусыОбращения.Новое И Объект.Статус = Перечисления.СтатусыОбращения.ВРаботе Тогда	
				Реакция = РегистрыСведений.СостояниеОбращений.ПолучитьВремяРеакцииНаТекПериод(Объект.Ссылка, ДатаСеанса);	
			ИначеЕсли ТекВерсияОбращения.СтатусРесурс = Перечисления.СтатусыОбращения.ВРаботе И Объект.Статус = Перечисления.СтатусыОбращения.ОжидаетКлиента Тогда 	
				Решение = РегистрыСведений.СостояниеОбращений.ПолучитьВремяРешенияНаТекПериод(Объект.Ссылка, ДатаСеанса, Перечисления.СтатусыОбращения.ВРаботе);
			ИначеЕсли ТекВерсияОбращения.СтатусРесурс = Перечисления.СтатусыОбращения.ВозвращеноКлиентом И Объект.Статус = Перечисления.СтатусыОбращения.ВРаботе Тогда 	
				ПовторнаяРеакция = РегистрыСведений.СостояниеОбращений.ПолучитьВремяРешенияНаТекПериод(Объект.Ссылка, ДатаСеанса, Перечисления.СтатусыОбращения.ВозвращеноКлиентом);	
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;	
	
	Запись = РегистрыСведений.ПоказателиSLAПоОбращениям.СоздатьМенеджерЗаписи();
    Запись.Обращение = Объект.Ссылка;
    Запись.Прочитать();
	
	Реакция = ?(Реакция = Неопределено, 0, Реакция);
	Решение = ?(Решение = Неопределено, 0, Решение);
	ПовторнаяРеакция = ?(ПовторнаяРеакция = Неопределено, 0, ПовторнаяРеакция);
	
    Если Запись.Выбран() Тогда
        Запись.Реакция = Запись.Реакция + Реакция;
        Запись.Решение = Запись.Решение + Решение;
		Запись.ПовторнаяРеакция = Запись.ПовторнаяРеакция + ПовторнаяРеакция;
        Запись.Записать(Истина);
    Иначе
        Запись.Обращение = Объект.Ссылка;
        Запись.Реакция = Реакция;
        Запись.Решение = Решение; 
		Запись.ПовторнаяРеакция = ПовторнаяРеакция;
        Запись.Записать(Истина);
    КонецЕсли;
	
	НаборЗаписей = РегистрыСведений.СостояниеОбращений.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Обращение.Установить(Объект.Ссылка); 
	НаборЗаписей.Отбор.Период.Установить(ДатаСеанса);
	
	Запись = НаборЗаписей.Добавить(); 
	ЗаполнитьЗначенияСвойств(Запись, СтруктураОбращения);
	Запись.Период = ДатаСеанса;
	Запись.СтатусРесурс = Запись.Статус;
	
	НаборЗаписей.Записать();
	
КонецПроцедуры

Процедура ЗаполнитьИсполнителя(Объект) Экспорт
	
	ПриоритетОбращения = Объект.Приоритет;
	ИсполнительНазначен = Ложь;
	СтатусВРаботе = Перечисления.СтатусыОбращения.ВРаботе;
	
	Если ПриоритетОбращения = Перечисления.ПриоритетыОбращения.Срочный Тогда
		
	    МинимальныйТребуемыйБалл = 4;
	    
	ИначеЕсли ПриоритетОбращения = Перечисления.ПриоритетыОбращения.Высокий Тогда
		
	    МинимальныйТребуемыйБалл = 3;
	    
	ИначеЕсли ПриоритетОбращения = Перечисления.ПриоритетыОбращения.Средний Тогда
		
	    МинимальныйТребуемыйБалл = 2;
	    
	Иначе
		
	    МинимальныйТребуемыйБалл = 0; 
	    
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	Обращения.Исполнитель КАК Исполнитель,
		|	КОЛИЧЕСТВО(Обращения.Ссылка) КАК КоличествоОбращений
		|ПОМЕСТИТЬ втЗанятость
		|ИЗ
		|	Справочник.Обращения КАК Обращения
		|ГДЕ
		|	Обращения.Статус = &Статус
		|
		|СГРУППИРОВАТЬ ПО
		|	Обращения.Исполнитель
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НавыкиСотрудников.Сотрудник КАК Сотрудник,
		|	НавыкиСотрудников.КоличествоБаллов / НавыкиСотрудников.КоличествоВопросов КАК СреднийБалл,
		|	втЗанятость.КоличествоОбращений КАК КоличествоОбращений
		|ИЗ
		|	РегистрСведений.НавыкиСотрудников КАК НавыкиСотрудников
		|		ЛЕВОЕ СОЕДИНЕНИЕ втЗанятость КАК втЗанятость
		|		ПО (втЗанятость.Исполнитель = НавыкиСотрудников.Сотрудник)
		|
		|УПОРЯДОЧИТЬ ПО
		|	СреднийБалл УБЫВ,
		|	КоличествоОбращений";
	
	Запрос.УстановитьПараметр("Статус", СтатусВРаботе);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если НЕ Выборка.СреднийБалл = NULL Тогда 
		Если Выборка.СреднийБалл > МинимальныйТребуемыйБалл Тогда
			
    		Объект.Исполнитель = Выборка.Сотрудник;
    		ИсполнительНазначен = Истина;
    		Прервать;
    		
		КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Если Не ИсполнительНазначен Тогда
		
		Сообщить("Не удалось автоматически подобрать оптимального Исполнителя");
		
	КонецЕсли;

КонецПроцедуры
















Функция БинарныеДанныеВСтрокуUTF8(БинарныеДанные)
    
    Попытка
        // Временный файл для конвертации
        ВременныйФайл = ПолучитьИмяВременногоФайла("txt"); 
        
        // Создаем COM-объект для работы с потоком
        Поток = Новый COMОбъект("ADODB.Stream");
        Поток.Type = 1; // adTypeBinary - указываем, что работаем с бинарными данными
        Поток.Open();
        
        // Помещаем бинарные данные в поток
        Поток.Write(БинарныеДанные);
        Поток.Position = 0; // Возвращаемся в начало потока
        
        // Меняем тип потока на текстовый и указываем кодировку
        Поток.Type = 2; // adTypeText
        Поток.Charset = "utf-8"; // Указываем кодировку исходных данных
        
        // Читаем текст из потока
        Результат = Поток.ReadText();
        Поток.Close();
        
        Возврат Результат;
        
    Исключение
        Сообщить("Ошибка преобразования бинарных данных: " + ОписаниеОшибки());
        Возврат "";
    КонецПопытки;
    
КонецФункции

Функция РазобратьJSONПравильно(JSONСтрока)
    
    Попытка
        Сообщить("Получен ответ от сервера: " + JSONСтрока);
        
        // РУЧНОЙ РАЗБОР JSON через строковые функции
        Данные = Новый Структура;
        
        // Убираем фигурные скобки и пробелы
        JSONСтрока = СокрЛП(СтрЗаменить(JSONСтрока, "{", ""));
        JSONСтрока = СокрЛП(СтрЗаменить(JSONСтрока, "}", ""));
        
        // Разбиваем по запятым на отдельные пары "ключ:значение"
        Пары = СтрРазделить(JSONСтрока, ",");
        
        Для Каждого Пара Из Пары Цикл
            Пара = СокрЛП(Пара);
            Если Найти(Пара, ":") > 0 Тогда
                // Разбиваем на ключ и значение
                КлючИЗначение = СтрРазделить(Пара, ":");
                Если КлючИЗначение.Количество() >= 2 Тогда
                    Ключ = СокрЛП(СтрЗаменить(КлючИЗначение[0], """", ""));
                    Значение = СокрЛП(СтрЗаменить(КлючИЗначение[1], """", ""));
                    Данные.Вставить(Ключ, Значение);
                КонецЕсли;
            КонецЕсли;
        КонецЦикла;
        
        // Выводим что получили
        Сообщить("Успешно разобрано полей: " + Данные.Количество());
        Для Каждого Элемент Из Данные Цикл
            Сообщить(Элемент.Ключ + " = " + Элемент.Значение);
        КонецЦикла;
        
        Возврат Данные;
        
    Исключение
        Сообщить("Ошибка при разборе JSON: " + ОписаниеОшибки());
        Возврат Неопределено;
    КонецПопытки;
    
КонецФункции
