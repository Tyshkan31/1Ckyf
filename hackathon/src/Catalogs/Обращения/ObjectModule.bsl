Перем СтарыйИсполнитель;
Перем ЭтоНовыйОбъект;

Процедура ПередЗаписью(Отказ)
    
    // Сохраняем признак нового объекта
    ЭтоНовыйОбъект = ЭтоНовый();
    
    // Сохраняем старого исполнителя
    Если НЕ ЭтоНовыйОбъект Тогда
        СтарыйИсполнитель = Ссылка.Исполнитель;
    Иначе
        СтарыйИсполнитель = Неопределено;
    КонецЕсли;
	//Тут тоже важный момент. Не надо спамить пользователю при каждой перезаписи, для этого сравним объект со ссылкой.
	Если ЭтоНовыйОбъект Тогда
		РазрешитьРассылку = Истина;
	Иначе
		СтатусСсылка = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭтотОбъект.Ссылка, "Статус");
		СтатусОбъект = Статус;
		РазрешитьРассылку = НЕ СтатусСсылка = СтатусОбъект;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(ЧатИД) Тогда
		ТекущееСостояниеПользователя = ПолучитьТекущееСостояниеПользователя();
		Если НЕ ЗначениеЗаполнено(ТекущееСостояниеПользователя) Тогда
			Сообщить("Некорректно заполнен реквизит ЧатИД");
			Отказ = Истина;
			Возврат;
		КонецЕсли;
		Если Статус = Перечисления.СтатусыОбращения.ОжидаетКлиента И РазрешитьРассылку Тогда 
			ТекстСообщения = "Ваша заявка выполнена! Спасибо за ожидание.";
			Интеграции.ОтправитьСообщениеТелеграм(Число(ЧатИД), ТекстСообщения, Перечисления.СостоянияПользователей.ОцениваетВыполнение);
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры
Процедура ПриЗаписи(Отказ)
    
    // Проверяем флаг отключения оповещений
    Если ДополнительныеСвойства.Свойство("БезОповещения") Тогда
        Возврат;
    КонецЕсли;
    
    // Проверяем, что исполнитель заполнен
    Если НЕ ЗначениеЗаполнено(Исполнитель) Тогда
        Возврат;
    КонецЕсли;
    
    СоздаватьОповещение = Ложь;
    
    // Условие 1: Новое обращение с исполнителем
    Если ЭтоНовыйОбъект Тогда
        СоздаватьОповещение = Истина;
    КонецЕсли;
    
    // Условие 2: Изменился исполнитель
    Если НЕ ЭтоНовыйОбъект И (СтарыйИсполнитель <> Исполнитель) Тогда
        СоздаватьОповещение = Истина;
    КонецЕсли;
    
    // Создаем оповещение
    Если СоздаватьОповещение Тогда
        
        Заголовок = "Новое обращение!";
        
        // ИСПРАВЛЕННЫЙ ТЕКСТ - с кодом обращения
        Текст = СтрШаблон(
            "Вам назначено обращение %1%2Приоритет: %3, Статус: %4",
            Код,  // ИЛИ Номер - в зависимости от того, что используется
            Символы.ПС,
            Приоритет,
            Статус
        );
        
        УникальныйКлюч = "Обращение_" + Строка(Ссылка);
        
        // Вызываем серверную функцию создания оповещения
        ОповещенияСервер.СоздатьОповещение(
            Исполнитель,
            Заголовок,
            Текст,
            Ссылка,
            УникальныйКлюч
        );
        
    КонецЕсли;
    
КонецПроцедуры

Функция ПолучитьТекущееСостояниеПользователя()

	Запрос = новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	СостояниеТГПользователя.ТекущееСостояние КАК ТекущееСостояние
	               |ИЗ
	               |	РегистрСведений.СостояниеТГПользователя КАК СостояниеТГПользователя
	               |ГДЕ
	               |	СостояниеТГПользователя.idUser = &idUser";
	Запрос.УстановитьПараметр("idUser" , Число(ЧатИД));
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.ТекущееСостояние;
	КонецЕсли;
	
	Возврат Неопределено;
	
	

КонецФункции