
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
//{{MRG[ <-> ]
	ДатаСеансаОткрытие = ТекущаяДатаСеанса();
	//Элементы.Код.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
//}}MRG[ <-> ]
//{{MRG[ <-> ]
//	Элементы.Код.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
//	Элементы.Наименование.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
//}}MRG[ <-> ]
	//Элементы.Наименование.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
	СписокТрудозатрат.Параметры.УстановитьЗначениеПараметра("Обращение", Объект.Ссылка);
	СписокТрудозатрат.Параметры.УстановитьЗначениеПараметра("Исполнитель", Пользователи.ТекущийПользователь());
	
	Если Объект.Ссылка.Пустая() Тогда 
//{{MRG[ <-> ]
		Объект.Статус = Перечисления.СтатусыОбращения.Новое; 
//}}MRG[ <-> ]
//{{MRG[ <-> ]
//		Объект.Статус = Перечисления.СтатусыОбращения.Новое;
//}}MRG[ <-> ]
		Объект.ДатаСоздания = ТекущаяДатаСеанса();
	КонецЕсли;
	ПриоритетОбращения = Объект.Приоритет;
	ИсполнительНазначен = Ложь;
	СтатусВРаботе = Перечисления.СтатусыОбращения.ВРаботе;
	
	Если ПриоритетОбращения = Перечисления.ПриоритетыОбращения.Срочный Тогда
		
	    МинимальныйТребуемыйБалл = 4;
	    
	ИначеЕсли ПриоритетОбращения = Перечисления.ПриоритетыОбращения.Высокий Тогда
		
	    МинимальныйТребуемыйБалл = 3;
	    
	ИначеЕсли ПриоритетОбращения = Перечисления.ПриоритетыОбращения.Средний Тогда
		
	    МинимальныйТребуемыйБалл = 2;
	    
	Иначе
		
	    МинимальныйТребуемыйБалл = 0; 
	    
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	Обращения.Исполнитель КАК Исполнитель,
		|	КОЛИЧЕСТВО(Обращения.Ссылка) КАК КоличествоОбращений
		|ПОМЕСТИТЬ втЗанятость
		|ИЗ
		|	Справочник.Обращения КАК Обращения
		|ГДЕ
		|	Обращения.Статус = &Статус
		|СГРУППИРОВАТЬ ПО
		|	Обращения.Исполнитель
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	НавыкиСотрудников.Сотрудник КАК Сотрудник,
		|	НавыкиСотрудников.КоличествоБаллов / НавыкиСотрудников.КоличествоВопросов КАК СреднийБалл,
		|	втЗанятость.КоличествоОбращений КАК КоличествоОбращений
		|ИЗ
		|	втЗанятость КАК втЗанятость
		|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.НавыкиСотрудников КАК НавыкиСотрудников
		|		ПО втЗанятость.Исполнитель = НавыкиСотрудников.Сотрудник
		|
		|УПОРЯДОЧИТЬ ПО
		|	КоличествоОбращений";
	
	Запрос.УстановитьПараметр("Статус", СтатусВРаботе);
	
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Если НЕ Выборка.СреднийБалл = NULL Тогда 
		Если Выборка.СреднийБалл > МинимальныйТребуемыйБалл Тогда
			
    		Объект.Исполнитель = Выборка.Исполнитель;
    		ИсполнительНазначен = Истина;
    		Продолжить;
    		
		КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Если Не ИсполнительНазначен Тогда
		
		Сообщить("Не удалось автоматически подобрать оптимального Исполнителя");
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
		
	НастройкаТемы = ПолучитьТему(); 
	
	Если НастройкаТемы = ТемаКлиентскогоПриложения.Темная ИЛИ НастройкаТемы = ТемаКлиентскогоПриложения.Авто Тогда
		ТемнаяТема = Истина; 
	Иначе
		ТемнаяТема = Ложь;
	КонецЕсли;
	
	ЗатраченоМин = ПолучитьТрудоЗатраты() * 60;
	ПолеHTML = ПолучитьHTMLВиджета(ЗатраченоМин, , , ТемнаяТема);
		
	Сотрудники = ПолучитьТрудоЗатратыПоСотрудникам(); 
	//Сотрудники.Добавить(Новый Структура("ФИО,Часы", "Иванов Иван Иванович", 5.5));
	//Сотрудники.Добавить(Новый Структура("ФИО,Часы", "Петров Пётр Петрович", 3));
	//Сотрудники.Добавить(Новый Структура("ФИО,Часы", "Сидорова Мария Юрьевна", 8));
	
	ПолеСотрудникиHTML = ПолучитьHTMLВиджетаСотрудники(Сотрудники, ТемнаяТема);
	
	// pause  done  work   (1,2,3 - время реакции) (4,5,6 - время решения)  
	СоответствиеSLA = ПодготовитьЗначенияSLA();
	СтруктураРеакции = СоответствиеSLA.Получить("Реакция");
	СтруктураРешения = СоответствиеSLA.Получить("Решение");
	ПолеSLA =ПолучитьHTMLSLA(СтруктураРеакции.ТекВремя, СтруктураРеакции.Статус, СтруктураРеакции.ЭталонВремя, 
								СтруктураРешения.ТекВремя, СтруктураРешения.Статус, СтруктураРешения.ЭталонВремя, ТемнаяТема);

КонецПроцедуры

&НаСервере
Функция ПодготовитьЗначенияSLA() 

	СтруктураSLA = РегистрыСведений.МетрикиSLA.ПолучитьЗначениеМетрикSLA(Объект.Приоритет, Объект.Тип);
	Если Объект.Статус = Перечисления.СтатусыОбращения.Новое Тогда 
		Если Объект.Ссылка.Пустая() Тогда 
			ВремяРеакции = СтруктураSLA.Реакция;
		Иначе 
			ВремяРеакции = РегистрыСведений.СостояниеОбращений.ПолучитьВремяРеакцииНаТекПериод(Объект.Ссылка,ДатаСеансаОткрытие);
		КонецЕсли;         
		СтатусРеакции = "work";
		СтатусРешения = "";
		ВремяРешения = 0;
	ИначеЕсли Объект.Статус = Перечисления.СтатусыОбращения.ВРаботе Тогда
		ТекДанныеSLA = РегистрыСведений.ПоказателиSLAПоОбращениям.ПолучитьПоказателиSLA(Объект.Ссылка);
		РешениеТек = РегистрыСведений.СостояниеОбращений.ПолучитьВремяРешенияНаТекПериод(Объект.Ссылка, ДатаСеансаОткрытие);  
		ВремяРеакции = ТекДанныеSLA.Реакция; 
		ВремяРешения = ТекДанныеSLA.Решение + РешениеТек;	
		СтатусРеакции = "done";
		СтатусРешения = "work";
	ИначеЕсли Объект.Статус = Перечисления.СтатусыОбращения.ОжидаетКлиента Тогда 
		ТекДанныеSLA = РегистрыСведений.ПоказателиSLAПоОбращениям.ПолучитьПоказателиSLA(Объект.Ссылка);	
		ВремяРеакции = ТекДанныеSLA.Реакция;
		ВремяРешения = ТекДанныеSLA.Решение;
		СтатусРеакции = "done";
		СтатусРешения = "pause";
	Иначе
		ТекДанныеSLA = РегистрыСведений.ПоказателиSLAПоОбращениям.ПолучитьПоказателиSLA(Объект.Ссылка);	
		ВремяРеакции = ТекДанныеSLA.Реакция;
		ВремяРешения = ТекДанныеSLA.Решение;  
		СтатусРеакции = "done";
		СтатусРешения = "done";
	КонецЕсли;
	
	СоответствиеSLA = Новый Соответствие;
	СоответствиеSLA.Вставить("Реакция", Новый Структура("ТекВремя, ЭталонВремя, Статус", ВремяРеакции, СтруктураSLA.Реакция, СтатусРеакции));
	СоответствиеSLA.Вставить("Решение", Новый Структура("ТекВремя, ЭталонВремя, Статус", ВремяРешения, СтруктураSLA.Решение, СтатусРешения));

    Возврат СоответствиеSLA;
	
КонецФункции

&НаСервере
Функция ПолучитьТему()
	КлючНастройкиКлиентскогоПриложения = "Общее/НастройкиКлиентскогоПриложения";
	Возврат	ХранилищеСистемныхНастроек.Загрузить(КлючНастройкиКлиентскогоПриложения).ТемаКлиентскогоПриложения;
КонецФункции

&НаСервере
Функция ПолучитьТрудоЗатраты()

	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТрудозатратыОбращенийОбороты.ЧасыОборот КАК ЧасыОборот
		|ИЗ
		|	РегистрНакопления.ТрудозатратыОбращений.Обороты КАК ТрудозатратыОбращенийОбороты
		|ГДЕ
		|	ТрудозатратыОбращенийОбороты.Обращение = &Обращение";
	
	Запрос.УстановитьПараметр("Обращение", Объект.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Если ВыборкаДетальныеЗаписи.Следующий() Тогда
		Возврат ВыборкаДетальныеЗаписи.ЧасыОборот;
	Иначе
		Возврат 0;
	КонецЕсли;	
	
КонецФункции

&НаСервере
Функция ПолучитьТрудоЗатратыПоСотрудникам()
    Сотрудники = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ТрудозатратыОбращенийОбороты.Исполнитель КАК Исполнитель,
		|	ТрудозатратыОбращенийОбороты.ЧасыОборот КАК ЧасыОборот
		|ИЗ
		|	РегистрНакопления.ТрудозатратыОбращений.Обороты КАК ТрудозатратыОбращенийОбороты
		|ГДЕ
		|	ТрудозатратыОбращенийОбороты.Обращение = &Обращение";
	
	Запрос.УстановитьПараметр("Обращение", Объект.Ссылка);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл 
		Сотрудники.Добавить(Новый Структура("ФИО,Часы", ВыборкаДетальныеЗаписи.Исполнитель, Число(ВыборкаДетальныеЗаписи.ЧасыОборот)));
	КонецЦикла;  
	
	Возврат Сотрудники;
	
КонецФункции

&НаКлиенте
Процедура ТипПриИзменении(Элемент)   
	//Для кнопки
	//Оповещение = Новый ОписаниеОповещения("ПослеЗакрытияЗначения", ЭтотОбъект);
	//ПоказатьВводЗначения(Оповещение, Объект.ТональностьОтзыва); 	
КонецПроцедуры

//{{MRG[ <-> ]
//#Область ОбработчикиСобытийЭлементовТаблицыФормыСписокТрудозатрат
//}}MRG[ <-> ]

#Область ОбработчикиСобытийЭлементовТаблицыФормыСписокТрудозатрат

&НаКлиенте
Процедура СписокТрудозатратВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	
	ОткрытьФорму("ОбщаяФорма.ВводЧасов",Новый Структура("Обращение, Регистратор", 
		Объект.Ссылка, Элемент.ТекущиеДанные.Регистратор));
			
КонецПроцедуры

&НаКлиенте
Процедура ОтразитьЧасы(Команда)
	
	ОткрытьФорму("ОбщаяФорма.ВводЧасов",Новый Структура("Обращение", Объект.Ссылка));
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗаписью(Отказ, ПараметрыЗаписи)
	
	Если Не Отказ И Модифицированность Тогда 
		ЗаписатьСостояниеОбращенийНаСервере();
	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура ЗаписатьСостояниеОбращенийНаСервере()  
	
	ДатаСеанса = ТекущаяДатаСеанса();
	Объект.ДатаОбновления = ДатаСеанса;
	СтруктураОбращения = Новый Структура("Обращение, Сотрудник, Статус, СлужебныйКомментарий");
	СтруктураОбращения.Обращение = Объект.Ссылка;
	СтруктураОбращения.Статус = Объект.Статус;

	НовоеОбращение = Ложь;
	Если Объект.Статус = Перечисления.СтатусыОбращения.Новое Тогда 
		НовоеОбращение = Истина;			
	КонецЕсли;
	
	Если НовоеОбращение Тогда  	
		СтруктураОбращения.Сотрудник = Справочники.Пользователи.СистемныйПользователь;
		СтруктураОбращения.СлужебныйКомментарий = СтрШаблон("Создано новое обращение. Автор обращения: %1", Объект.Автор); 
	Иначе
		Отбор = Новый Структура;
		Отбор.Вставить("Обращение", Объект.Ссылка);
		ПоследнееОбращение = РегистрыСведений.СостояниеОбращений;
		ТекВерсияОбращения = ПоследнееОбращение.ПолучитьПоследнее(ДатаСеанса, Отбор);
		
		Если ТекВерсияОбращения.Статус = Объект.Статус Тогда 
			Возврат;
		Иначе  
			СтруктураОбращения.Сотрудник = Объект.Исполнитель;
			Если Объект.Статус = Перечисления.СтатусыОбращения.Новое Тогда  
				СтруктураОбращения.СлужебныйКомментарий = СтрШаблон("Создано новое обращение. Автор обращения: %1", Объект.Автор); 	
			ИначеЕсли Объект.Статус = Перечисления.СтатусыОбращения.ВРаботе Тогда 
				СтруктураОбращения.СлужебныйКомментарий = СтрШаблон("Обращение принято в работу. Исполнитель: %1", Объект.Исполнитель); 
			ИначеЕсли Объект.Статус = Перечисления.СтатусыОбращения.ОжидаетКлиента Тогда 
				СтруктураОбращения.СлужебныйКомментарий = СтрШаблон("Обращение передано клиенту: %1", Объект.Автор);
			ИначеЕсли Объект.Статус = Перечисления.СтатусыОбращения.Закрыто Тогда 	
				СтруктураОбращения.СлужебныйКомментарий = СтрШаблон("Обращение закрыто"); 
			КонецЕсли; 
			
			Решение = 0;
			Реакция = 0;
//{{MRG[ <-> ]
			Если ТекВерсияОбращения.Статус = Перечисления.СтатусыОбращения.Новое И Объект.Статус = Перечисления.СтатусыОбращения.ВРаботе Тогда	
				Реакция = РегистрыСведений.СостояниеОбращений.ПолучитьВремяРеакцииНаТекПериод(Объект.Ссылка, ДатаСеанса);	
			ИначеЕсли ТекВерсияОбращения.Статус = Перечисления.СтатусыОбращения.ВРаботе И Объект.Статус = Перечисления.СтатусыОбращения.ОжидаетКлиента Тогда 	
				Решение = РегистрыСведений.СостояниеОбращений.ПолучитьВремяРешенияНаТекПериод(Объект.Ссылка, ДатаСеанса);
//}}MRG[ <-> ]
//{{MRG[ <-> ]
//			Если ТекВерсияОбращения.Статус = Перечисления.СтатусыОбращения.Новое И Объект.Статус = Перечисления.СтатусыОбращения.ВРаботе Тогда
//				
//				Запрос = Новый Запрос;
//				Запрос.Текст = 
//}}MRG[ <-> ]
//{{MRG[ <-> ]
//				"ВЫБРАТЬ
//				|	РАЗНОСТЬДАТ(СостояниеОбращенийСрезПервых.Период, &ТекПериод, МИНУТА) КАК Реакция
//				|ИЗ
//				|	РегистрСведений.СостояниеОбращений.СрезПервых КАК СостояниеОбращенийСрезПервых
//				|ГДЕ
//				|	СостояниеОбращенийСрезПервых.Обращение = &Обращение
//				|	И СостояниеОбращенийСрезПервых.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОбращения.Новое)";
//				
//				Запрос.УстановитьПараметр("Обращение", Объект.Ссылка);
//				Запрос.УстановитьПараметр("ТекПериод", ДатаСеанса);
//				
//				РезультатЗапроса = Запрос.Выполнить();
//				
//				ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
//				
//				Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
//					Реакция = ВыборкаДетальныеЗаписи.Реакция; 
//				КонецЦикла;
//				
//			ИначеЕсли ТекВерсияОбращения.Статус = Перечисления.СтатусыОбращения.ВРаботе И Объект.Статус = Перечисления.СтатусыОбращения.ОжидаетКлиента Тогда 
//				Запрос = Новый Запрос;
//				Запрос.Текст = 
//				"ВЫБРАТЬ
//				|	РАЗНОСТЬДАТ(СостояниеОбращенийСрезПоследних.Период, &ТекПериод, МИНУТА) КАК Решение
//				|ИЗ
//				|	РегистрСведений.СостояниеОбращений.СрезПоследних КАК СостояниеОбращенийСрезПоследних
//				|ГДЕ
//				|	СостояниеОбращенийСрезПоследних.Обращение = &Обращение
//				|	И СостояниеОбращенийСрезПоследних.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыОбращения.ВРаботе)";
//				
//				Запрос.УстановитьПараметр("Обращение", Объект.Ссылка); 
//				Запрос.УстановитьПараметр("ТекПериод", ДатаСеанса);
//				
//				РезультатЗапроса = Запрос.Выполнить();
//				
//				ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
//				
//				Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
//					Решение = ВыборкаДетальныеЗаписи.Решение; 
//				КонецЦикла;		
//}}MRG[ <-> ]
			КонецЕсли;
			
		КонецЕсли;
	КонецЕсли;	
	
	Запись = РегистрыСведений.ПоказателиSLAПоОбращениям.СоздатьМенеджерЗаписи();
    Запись.Обращение = Объект.Ссылка;
    Запись.Прочитать();

    Если Запись.Выбран() Тогда
        Запись.Реакция = Запись.Реакция + Реакция;
        Запись.Решение = Запись.Решение + Решение;
        Запись.Записать(Истина);
    Иначе
        Запись.Обращение = Объект.Ссылка;
        Запись.Реакция = Реакция;
        Запись.Решение = Решение;
        Запись.Записать(Истина);
    КонецЕсли;
	
	НаборЗаписей = РегистрыСведений.СостояниеОбращений.СоздатьНаборЗаписей();
	НаборЗаписей.Отбор.Обращение.Установить(Объект.Ссылка); 
	НаборЗаписей.Отбор.Период.Установить(ДатаСеанса);
	
	Запись = НаборЗаписей.Добавить(); 
	ЗаполнитьЗначенияСвойств(Запись, СтруктураОбращения);
	Запись.Период = ДатаСеанса;
	
//{{MRG[ <-> ]
	НаборЗаписей.Записать();
//}}MRG[ <-> ]
//{{MRG[ <-> ]
//	НаборЗаписей.Записать();	
//}}MRG[ <-> ]
	
КонецПроцедуры

&НаКлиенте
Процедура ТипОбработкаВыбора(Элемент, ВыбранноеЗначение, ДополнительныеДанные, ВыборДобавлением, СтандартнаяОбработка)
	ОбработкаВыбораУниверсальная(Элемент, ВыбранноеЗначение, СтандартнаяОбработка);
КонецПроцедуры

&НаКлиенте
Процедура ПриоритетОбработкаВыбора(Элемент, ВыбранноеЗначение, ДополнительныеДанные, ВыборДобавлением, СтандартнаяОбработка)
	ОбработкаВыбораУниверсальная(Элемент, ВыбранноеЗначение, СтандартнаяОбработка);
КонецПроцедуры


&НаКлиенте
Процедура ОбработкаВыбораУниверсальная(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	СтандартнаяОбработка = Ложь;
	ДиалогВыбора = РежимДиалогаВопрос.ДаНет;
	ИмяЭлемента = Элемент.Имя;
	Ответ = Вопрос("Изменить " + НРег(ИмяЭлемента) + "?", ДиалогВыбора, 0);
	
	Если Ответ = КодВозвратаДиалога.Да Тогда
		Объект.Тип = ВыбранноеЗначение;
	КонецЕсли;


КонецПроцедуры

&НаКлиенте
Процедура ТональностьОбработкаВыбора(Элемент, ВыбранноеЗначение, ДополнительныеДанные, ВыборДобавлением, СтандартнаяОбработка)
	ОбработкаВыбораУниверсальная(Элемент, ВыбранноеЗначение, СтандартнаяОбработка);
КонецПроцедуры

//{{MRG[ <-> ]
#КонецОбласти  
//}}MRG[ <-> ]
//{{MRG[ <-> ]
//#КонецОбласти
//}}MRG[ <-> ]

&НаКлиенте
Функция ПолучитьHTMLВиджета(LogMin, EstMin = Неопределено, RemMin = Неопределено, ТемнаяТема = Ложь)
	// Если Осталось не задано, но есть Est и Log — считаем как max(0, Est - Log)
	Если RemMin = Неопределено И ЗначениеЗаполнено(EstMin) И ЗначениеЗаполнено(LogMin) Тогда
		RemMin = Макс(0, Число(EstMin) - Число(LogMin));
	КонецЕсли;

	// Пустая строка в data-* = «не определено»
	СтEst = ?(ЗначениеЗаполнено(EstMin), Строка(Число(EstMin)), "");
	СтRem = ?(ЗначениеЗаполнено(RemMin), Строка(Число(RemMin)), "");
	СтLog = ?(ЗначениеЗаполнено(LogMin), Строка(Число(LogMin)), "");

	// Параметры цвета зависят от темы
	ЦветПодписи = ?(ТемнаяТема, "#e5e7eb", "#111");
	ЦветЗнач    = ?(ТемнаяТема, "#f8fafc", "#111");
	ЦветГлуше   = ?(ТемнаяТема, "#9ca3af", "#64748b");
	ЦветТрек    = ?(ТемнаяТема, "#334155", "#e5e7eb");

	Шаблон =
"<!doctype html>
|<html lang='ru'>
|<head>
|<meta charset='utf-8'/>
|<meta name='viewport' content='width=device-width, initial-scale=1'/>
|<style>
|:root{
|  --muted:%MUTED%;
|  --track:%TRACK%;
|  --est:#3b82f6; --rem:#f59e0b; --log:#22c55e; --over:#ef4444;
|  font-family:-apple-system,Segoe UI,Roboto,Arial,sans-serif;
|}
|body{margin:0;padding:10px}
|.row{display:flex;align-items:center;gap:10px;margin:10px 0}
|.label{width:90px;font-size:13px;color:%LBL%}
|.track{flex:1;height:8px;background:var(--track);border-radius:999px;position:relative;overflow:hidden}
|.fill{position:absolute;top:0;height:100%;width:0;border-radius:999px;transition:width .2s ease}
|.fill.est{left:0;background:var(--est)}         /* оценка — 100% если >0 */
|.fill.rem{left:0;background:var(--rem)}         /* осталось — слева направо */
|.fill.log{left:0;background:var(--log)}         /* затрачено — слева направо */
|.row.over .fill.log{background:var(--over)}
|.value{width:120px;text-align:right;font-size:12px;color:%VAL%}
|.value.muted{color:var(--muted)}
|</style>
|</head>
|<body>
|  <div id='w' data-est='%EST%' data-rem='%REM%' data-log='%LOG%'>
|    <div class='row' id='row-est' data-kind=est>
|      <span class='label'>Оценка</span>
|      <div class='track'><div class='fill est' id='fill-est'></div></div>
|      <span class='value' id='val-est'></span>
|    </div>
|    <div class='row' id='row-rem' data-kind=rem>
|      <span class='label'>Осталось</span>
|      <div class='track'><div class='fill rem' id='fill-rem'></div></div>
|      <span class='value' id='val-rem'></span>
|    </div>
|    <div class='row' id='row-log' data-kind=log>
|      <span class='label'>Затрачено</span>
|      <div class='track'><div class='fill log' id='fill-log'></div></div>
|      <span class='value' id='val-log'></span>
|    </div>
|  </div>
|<script>
|(function(){
|  var w = document.getElementById('w');
|  function rd(s){ return (s==null || s==='') ? null : Number(s); } // пустая строка -> null
|  var est = rd(w.dataset.est);
|  var log = rd(w.dataset.log);
|  var rem = (w.dataset.rem==='' || w.dataset.rem==null) ? null : rd(w.dataset.rem);
|  if(rem===null && est!==null && log!==null){ rem = Math.max(0, est - log); }
|
|  function clamp(n,min,max){return Math.max(min, Math.min(max,n));}
|  function fmt(min){
|    if(min===null) return 'Не определено';
|    min = Math.max(0, Math.floor(+min));
|    var d=Math.floor(min/1440), h=Math.floor((min%1440)/60), m=min%60, out=[];
|    if(d) out.push(d+'d'); if(h) out.push(h+'h'); if(m || !out.length) out.push(m+'m'); return out.join(' ');
|  }
|  function width(kind, val, estVal){
|    if(kind==='est') return (estVal!=null && estVal>0) ? 100 : 0;
|    if(kind==='log'){
|      if(estVal==null || estVal<=0) return (val!=null && val>0) ? 100 : 0; // без оценки — 100%
|      if(val==null) return 0;
|      return clamp((val/estVal)*100, 0, 100);
|    }
|    // rem
|    if(estVal==null || estVal<=0 || val==null) return 0;
|    return clamp((val/estVal)*100, 0, 100);
|  }
|  function setRow(kind, val, estVal, idFill, idVal, idRow){
|    var fill = document.getElementById(idFill);
|    var v    = document.getElementById(idVal);
|    var row  = document.getElementById(idRow);
|    fill.style.width = width(kind, val, estVal) + '%';
|    v.textContent = fmt(val);
|    v.classList.toggle('muted', val===null);
|    if(kind==='log'){ row.classList.toggle('over', (estVal!=null && estVal>0 && val!=null && val>estVal)); }
|  }
|  setRow('est', est, est, 'fill-est', 'val-est', 'row-est');
|  setRow('rem', rem, est, 'fill-rem', 'val-rem', 'row-rem');
|  setRow('log', log, est, 'fill-log', 'val-log', 'row-log');
|})();
|</script>
|</body>
|</html>";

	HTML = СтрЗаменить(Шаблон, "%EST%", СтEst);
	HTML = СтрЗаменить(HTML,   "%REM%", СтRem);
	HTML = СтрЗаменить(HTML,   "%LOG%", СтLog);

	HTML = СтрЗаменить(HTML,   "%LBL%",   ЦветПодписи);
	HTML = СтрЗаменить(HTML,   "%VAL%",   ЦветЗнач);
	HTML = СтрЗаменить(HTML,   "%MUTED%", ЦветГлуше);
	HTML = СтрЗаменить(HTML,   "%TRACK%", ЦветТрек);

	Возврат HTML;
КонецФункции 

&НаКлиенте
Функция ПолучитьHTMLВиджетаСотрудники(Данные, ТемнаяТема) Экспорт
	ЦветПодписи = ?(ТемнаяТема, "#e5e7eb", "#111");
	ЦветЗнач    = ?(ТемнаяТема, "#f8fafc", "#111");
	ЦветГлуше   = ?(ТемнаяТема, "#9ca3af", "#64748b");
	ЦветТрек    = ?(ТемнаяТема, "#334155", "#e5e7eb");
	ЦветПолоса  = ?(ТемнаяТема, "#44e372", "#22c55e");
	HTMLСписок = "";
	Если ТипЗнч(Данные) = Тип("Массив") Тогда
		Для Каждого Стр Из Данные Цикл
			ФИО        = Стр.ФИО;
			Часы       = Стр.Часы;
			СтВремя    = ФорматТрудозатратJira(Часы);
			КлассВремя = ?(Часы=Неопределено," muted","");
			HTMLСписок = HTMLСписок +
			"<div class='row'><span class='label'>" + ФИО + "</span>" +
			"<div class='track'><div class='fill'></div></div>" +
			"<span class='value" + КлассВремя + "'>" + СтВремя + "</span></div>";
		КонецЦикла;
	ИначеЕсли ТипЗнч(Данные) = Тип("ТаблицаЗначений") Тогда
		Для Каждого Р Из Данные Цикл
			ФИО        = Р.ФИО;
			Часы       = Р.Часы;
			СтВремя    = ФорматТрудозатратJira(Часы);
			КлассВремя = ?(Часы=Неопределено," muted","");
			HTMLСписок = HTMLСписок +
			"<div class='row'><span class='label'>" + ФИО + "</span>" +
			"<div class='track'><div class='fill'></div></div>" +
			"<span class='value" + КлассВремя + "'>" + СтВремя + "</span></div>";
		КонецЦикла;
	КонецЕсли;
	Шаблон =
"<!doctype html>
|<html lang='ru'>
|<head>
|<meta charset='utf-8'/>
|<style>
|:root{
|  --track:%TRACK%;
|  --main:%GREEN%;
|  --lbl:%LBL%;
|  --val:%VAL%;
|  --muted:%MUTED%;
|  font-family: -apple-system, Segoe UI, Roboto, Arial, sans-serif;
|}
|body{margin:0;padding:0;}
|.row{display:flex;align-items:center;gap:12px;margin:7px 0 7px 0;}
|.label{
|   width:78px;
|   min-width:62px;
|   max-width:110px;
|   overflow:hidden;
|   text-overflow:ellipsis;
|   font-size:12px;
|   color:%LBL%;
|   font-weight:400;
|}
|.track{
|   flex:1;
|   height:8px;
|   background:var(--track);
|   border-radius:999px;
|   position:relative;
|   overflow:hidden;
|}
|.fill{
|   position:absolute;
|   left:0; top:0; height:100%; width:100%;
|   background:var(--main);
|   border-radius:999px;
|}
|.value{
|   width:58px;
|   min-width:32px;
|   text-align:right;
|   font-variant-numeric:tabular-nums;
|   font-size:12px;
|   color:%VAL%;
|   font-weight:400;
|}
|.value.muted{color:var(--muted);}
|</style>
|</head>
|<body>
|" + HTMLСписок + "
|</body>
|</html>";
	HTML = Шаблон;
	HTML = СтрЗаменить(HTML, "%LBL%",   ЦветПодписи);
	HTML = СтрЗаменить(HTML, "%VAL%",   ЦветЗнач);
	HTML = СтрЗаменить(HTML, "%MUTED%", ЦветГлуше);
	HTML = СтрЗаменить(HTML, "%TRACK%", ЦветТрек);
	HTML = СтрЗаменить(HTML, "%GREEN%", ЦветПолоса);
	Возврат HTML;
КонецФункции 

&НаКлиенте
Функция ФорматТрудозатратJira(Часы)
	Если Часы = Неопределено Тогда
		Возврат "Не&nbsp;определено";
	КонецЕсли;
	М = Окр((Часы - Цел(Часы)) * 60, 0);
	Ч = Цел(Часы);
	Результат = "";
	Если Ч > 0 Тогда Результат = Результат + Строка(Ч) + "h "; КонецЕсли;
	Если М > 0  Тогда Результат = Результат + Строка(М) + "m"; КонецЕсли;
	Если Результат = "" Тогда Результат = "0m"; КонецЕсли;
	Возврат Результат;
КонецФункции  

&НаКлиенте
Функция ПолучитьHTMLSLA(
	ВремяРеакцииМинуты, СтатусРеакции, ЛимитРеакцииМинуты,
	ВремяРешенияМинуты, СтатусРешения, ЛимитРешенияМинуты,
	ТемнаяТема = Ложь
) Экспорт
	
	// Нормализация статусов
	СтатусРеакцииНорм = НРег(СокрЛП(Строка(СтатусРеакции)));
	СтатусРешенияНорм = НРег(СокрЛП(Строка(СтатусРешения)));
	
	// Определяем является ли статус "выполнено"
	ЭтоВыполненоРеакция = (СтатусРеакцииНорм = "выполнено" ИЛИ СтатусРеакцииНорм = "завершено" ИЛИ СтатусРеакцииНорм = "done" ИЛИ СтатусРеакцииНорм = "completed");
	ЭтоВыполненоРешение = (СтатусРешенияНорм = "выполнено" ИЛИ СтатусРешенияНорм = "завершено" ИЛИ СтатусРешенияНорм = "done" ИЛИ СтатусРешенияНорм = "completed");
	
	// Вычисляем просрочку
	ПросрочкаРеакции = ВремяРеакцииМинуты - ЛимитРеакцииМинуты;
	ПросрочкаРешения = ВремяРешенияМинуты - ЛимитРешенияМинуты;
	
	ЕстьПросрочкаРеакции = (ПросрочкаРеакции > 0);
	ЕстьПросрочкаРешения = (ПросрочкаРешения > 0);
	
	// Форматирование времени с новой логикой
	Если НЕ ЗначениеЗаполнено(ВремяРеакцииМинуты) ИЛИ ВремяРеакцииМинуты = 0 Тогда
		ВремяРеакцииТекст = "";
	Иначе
		Если ЭтоВыполненоРеакция Тогда
			// DONE: показываем фактическое время или минус при просрочке
			Если ЕстьПросрочкаРеакции Тогда
				ВремяРеакцииТекст = "-" + ФорматироватьВремяSLA(ПросрочкаРеакции);
			Иначе
				ВремяРеакцииТекст = ФорматироватьВремяSLA(ВремяРеакцииМинуты);
			КонецЕсли;
		Иначе
			// WORK: показываем остаток или минус при просрочке
			Если ЕстьПросрочкаРеакции Тогда
				ВремяРеакцииТекст = "-" + ФорматироватьВремяSLA(ПросрочкаРеакции);
			Иначе
				ОстатокРеакции = ЛимитРеакцииМинуты - ВремяРеакцииМинуты;
				ВремяРеакцииТекст = ФорматироватьВремяSLA(ОстатокРеакции);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ВремяРешенияМинуты) ИЛИ ВремяРешенияМинуты = 0 Тогда
		ВремяРешенияТекст = "";
	Иначе
		Если ЭтоВыполненоРешение Тогда
			// DONE: показываем фактическое время или минус при просрочке
			Если ЕстьПросрочкаРешения Тогда
				ВремяРешенияТекст = "-" + ФорматироватьВремяSLA(ПросрочкаРешения);
			Иначе
				ВремяРешенияТекст = ФорматироватьВремяSLA(ВремяРешенияМинуты);
			КонецЕсли;
		Иначе
			// WORK: показываем остаток или минус при просрочке
			Если ЕстьПросрочкаРешения Тогда
				ВремяРешенияТекст = "-" + ФорматироватьВремяSLA(ПросрочкаРешения);
			Иначе
				ОстатокРешения = ЛимитРешенияМинуты - ВремяРешенияМинуты;
				ВремяРешенияТекст = ФорматироватьВремяSLA(ОстатокРешения);
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	ЛимитРеакцииТекст = ФорматироватьВремяSLA(ЛимитРеакцииМинуты);
	ЛимитРешенияТекст = ФорматироватьВремяSLA(ЛимитРешенияМинуты);
	
	// Получение CSS-классов статусов
	КлассСтатуса1 = ПолучитьКлассСтатуса(СтатусРеакции, ЕстьПросрочкаРеакции);
	КлассСтатуса2 = ПолучитьКлассСтатуса(СтатусРешения, ЕстьПросрочкаРешения);
	
	// CSS класс для красного текста при просрочке
	КлассВремени1 = ?(ЕстьПросрочкаРеакции, "sla-time time-overdue", "sla-time");
	КлассВремени2 = ?(ЕстьПросрочкаРешения, "sla-time time-overdue", "sla-time");
	
	// Цветовая схема
	Если ТемнаяТема Тогда
		ЦветТекста = "#e6eaf0";
		ЦветТекстаВторичный = "#9fadbc";
		ЦветГраницы = "#1A1A1A";
		ЦветФона = "#1A1A1A";
		ЦветТени = "rgba(0, 0, 0, 0)";
		ЦветГолубой = "#3b9eff";
		ЦветОранжевый = "#ff9f43";
		ЦветЗеленый = "#4cd964";
		ЦветКрасный = "#ff3b30";
		ЦветЧерный = "#e6eaf0";
	Иначе
		ЦветТекста = "#172b4d";
		ЦветТекстаВторичный = "#5e6c84";
		ЦветГраницы = "#ffffff";
		ЦветФона = "#ffffff";
		ЦветТени = "rgba(23, 43, 77, 0.08)";
		ЦветГолубой = "#0052cc";
		ЦветОранжевый = "#ff8b00";
		ЦветЗеленый = "#36b37e";
		ЦветКрасный = "#de350b";
		ЦветЧерный = "#172b4d";
	КонецЕсли;
	
	// SVG-иконки для статусов
	ИконкаПауза = "<svg class='icon' viewBox='0 0 24 24'><g transform='translate(12,12)'><rect x='-5' y='-7' width='3' height='14' rx='1' fill='%BLACK%'/><rect x='2' y='-7' width='3' height='14' rx='1' fill='%BLACK%'/></g></svg>";
	
	ИконкаВыполнено = "<svg class='icon' viewBox='0 0 24 24'><g transform='translate(12,12)'><path d='M-7 0 L-1 6 L9 -7' stroke='%GREEN%' stroke-width='3.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/></g></svg>";
	
	ИконкаРаботаЧерная = "<svg class='icon' viewBox='0 0 24 24'><g transform='translate(12,12)'><circle cx='0' cy='0' r='7' stroke='%BLACK%' stroke-width='2' fill='none'/><line x1='0' y1='0' x2='0' y2='-4.5' stroke='%BLACK%' stroke-width='2' stroke-linecap='round'/><line x1='0' y1='0' x2='3.5' y2='0' stroke='%BLACK%' stroke-width='2' stroke-linecap='round'/></g></svg>";
	
	ИконкаРаботаКрасная = "<svg class='icon' viewBox='0 0 24 24'><g transform='translate(12,12)'><circle cx='0' cy='0' r='7' stroke='%RED%' stroke-width='2' fill='none'/><line x1='0' y1='0' x2='0' y2='-4.5' stroke='%RED%' stroke-width='2' stroke-linecap='round'/><line x1='0' y1='0' x2='3.5' y2='0' stroke='%RED%' stroke-width='2' stroke-linecap='round'/></g></svg>";
	
	ИконкаКрестик = "<svg class='icon' viewBox='0 0 24 24'><g transform='translate(12,12)'><line x1='-6' y1='-6' x2='6' y2='6' stroke='%RED%' stroke-width='2.5' stroke-linecap='round'/><line x1='6' y1='-6' x2='-6' y2='6' stroke='%RED%' stroke-width='2.5' stroke-linecap='round'/></g></svg>";
	
	// Замена цветов в иконках
	ИконкаПауза = СтрЗаменить(ИконкаПауза, "%BLACK%", ЦветЧерный);
	ИконкаВыполнено = СтрЗаменить(ИконкаВыполнено, "%GREEN%", ЦветЗеленый);
	ИконкаРаботаЧерная = СтрЗаменить(ИконкаРаботаЧерная, "%BLACK%", ЦветЧерный);
	ИконкаРаботаКрасная = СтрЗаменить(ИконкаРаботаКрасная, "%RED%", ЦветКрасный);
	ИконкаКрестик = СтрЗаменить(ИконкаКрестик, "%RED%", ЦветКрасный);
	
	Иконка1 = ВыбратьИконку(КлассСтатуса1, ИконкаПауза, ИконкаВыполнено, ИконкаРаботаЧерная, ИконкаРаботаКрасная, ИконкаКрестик);
	Иконка2 = ВыбратьИконку(КлассСтатуса2, ИконкаПауза, ИконкаВыполнено, ИконкаРаботаЧерная, ИконкаРаботаКрасная, ИконкаКрестик);
	
	// HTML шаблон
	Шаблон = 
	"<!DOCTYPE html>
	|<html lang='ru'>
	|<head>
	|<meta charset='UTF-8'>
	|<meta name='viewport' content='width=device-width,initial-scale=1'>
	|<style>
	|*{margin:0;padding:0;box-sizing:border-box}
	|body{
	|  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
	|  background:%BG%;
	|  color:%TEXT%;
	|  font-size:14px;
	|  line-height:1.4;
	|  -webkit-font-smoothing:antialiased;
	|}
	|.sla-card{
	|  background:%BG%;
	|  border:1px solid %BORDER%;
	|  border-radius:4px;
	|  box-shadow:0 1px 2px %SHADOW%;
	|  overflow:hidden;
	|}
	|.sla-row{
	|  display:flex;
	|  align-items:center;
	|  justify-content:space-between;
	|  padding:12px 16px;
	|  gap:16px;
	|}
	|.sla-row:not(:last-child){
	|  border-bottom:1px solid %BORDER%;
	|}
	|.sla-left{
	|  display:flex;
	|  align-items:center;
	|  flex-shrink:0;
	|}
	|.sla-time-wrapper{
	|  min-width:70px;
	|  text-align:right;
	|}
	|.sla-time{
	|  font-size:14px;
	|  font-weight:600;
	|  color:%TEXT%;
	|}
	|.sla-time.time-overdue{
	|  color:%RED%;
	|}
	|.sla-icon-wrapper{
	|  display:flex;
	|  align-items:center;
	|  justify-content:center;
	|  width:24px;
	|  margin-left:24px;
	|}
	|.icon{
	|  width:24px;
	|  height:24px;
	|  display:block;
	|}
	|.sla-right{
	|  flex:1;
	|  min-width:0;
	|  text-align:right;
	|}
	|.sla-title{
	|  font-size:14px;
	|  font-weight:600;
	|  color:%TEXT%;
	|  margin-bottom:2px;
	|}
	|.sla-target{
	|  font-size:12px;
	|  font-weight:400;
	|  color:%MUTED%;
	|}
	|@media(max-width:480px){
	|  .sla-row{padding:10px 12px;gap:12px}
	|  .sla-time-wrapper{min-width:60px}
	|  .sla-icon-wrapper{width:20px;margin-left:18px}
	|  .sla-time,.sla-title{font-size:13px}
	|  .sla-target{font-size:11px}
	|  .icon{width:20px;height:20px}
	|}
	|</style>
	|</head>
	|<body>
	|<div class='sla-card'>
	|  <div class='sla-row'>
	|    <div class='sla-left'>
	|      <div class='sla-time-wrapper'>
	|        <span class='%TIME_CLASS1%'>%TIME1%</span>
	|      </div>
	|      <div class='sla-icon-wrapper'>
	|        %ICON1%
	|      </div>
	|    </div>
	|    <div class='sla-right'>
	|      <div class='sla-title'>Время реакции</div>
	|      <div class='sla-target'>%TARGET1%</div>
	|    </div>
	|  </div>
	|  <div class='sla-row'>
	|    <div class='sla-left'>
	|      <div class='sla-time-wrapper'>
	|        <span class='%TIME_CLASS2%'>%TIME2%</span>
	|      </div>
	|      <div class='sla-icon-wrapper'>
	|        %ICON2%
	|      </div>
	|    </div>
	|    <div class='sla-right'>
	|      <div class='sla-title'>Время решения</div>
	|      <div class='sla-target'>%TARGET2%</div>
	|    </div>
	|  </div>
	|</div>
	|</body>
	|</html>";
	
	// Замена переменных цветов
	Шаблон = СтрЗаменить(Шаблон, "%TEXT%", ЦветТекста);
	Шаблон = СтрЗаменить(Шаблон, "%MUTED%", ЦветТекстаВторичный);
	Шаблон = СтрЗаменить(Шаблон, "%BORDER%", ЦветГраницы);
	Шаблон = СтрЗаменить(Шаблон, "%BG%", ЦветФона);
	Шаблон = СтрЗаменить(Шаблон, "%SHADOW%", ЦветТени);
	Шаблон = СтрЗаменить(Шаблон, "%RED%", ЦветКрасный);
	
	// Замена данных
	Шаблон = СтрЗаменить(Шаблон, "%TIME1%", ?(ПустаяСтрока(ВремяРеакцииТекст), "—", ВремяРеакцииТекст));
	Шаблон = СтрЗаменить(Шаблон, "%TIME2%", ?(ПустаяСтрока(ВремяРешенияТекст), "—", ВремяРешенияТекст));
	Шаблон = СтрЗаменить(Шаблон, "%TIME_CLASS1%", КлассВремени1);
	Шаблон = СтрЗаменить(Шаблон, "%TIME_CLASS2%", КлассВремени2);
	Шаблон = СтрЗаменить(Шаблон, "%TARGET1%", ?(ПустаяСтрока(ЛимитРеакцииТекст), "", "в течение " + ЛимитРеакцииТекст));
	Шаблон = СтрЗаменить(Шаблон, "%TARGET2%", ?(ПустаяСтрока(ЛимитРешенияТекст), "", "в течение " + ЛимитРешенияТекст));
	Шаблон = СтрЗаменить(Шаблон, "%ICON1%", Иконка1);
	Шаблон = СтрЗаменить(Шаблон, "%ICON2%", Иконка2);
	
	Возврат Шаблон;
	
КонецФункции

&НаКлиенте
Функция ФорматироватьВремяSLA(Минуты)
	
	Если НЕ ЗначениеЗаполнено(Минуты) ИЛИ Минуты = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	МинутыЧисло = Число(Минуты);
	МинутыЧисло = ?(МинутыЧисло < 0, -МинутыЧисло, МинутыЧисло);
	
	Если МинутыЧисло < 60 Тогда
		Возврат Строка(МинутыЧисло) + "m";
	КонецЕсли;
	
	Часы = Цел(МинутыЧисло / 60);
	ОстатокМинут = МинутыЧисло % 60;
	
	Если ОстатокМинут = 0 Тогда
		Возврат Строка(Часы) + "h";
	Иначе
		Возврат Строка(Часы) + "h " + Строка(ОстатокМинут) + "m";
	КонецЕсли;
	
КонецФункции

&НаКлиенте
Функция ПолучитьКлассСтатуса(Статус, ЕстьПросрочка = Ложь)
	
	Если НЕ ЗначениеЗаполнено(Статус) Тогда
		Возврат ?(ЕстьПросрочка, "overdue-work", "work");
	КонецЕсли;
	
	СтатусНижний = НРег(СокрЛП(Строка(Статус)));
	
	Если СтатусНижний = "на паузе" ИЛИ СтатусНижний = "pause" ИЛИ СтатусНижний = "paused" Тогда
		Возврат "pause";
	ИначеЕсли СтатусНижний = "выполнено" ИЛИ СтатусНижний = "завершено" ИЛИ СтатусНижний = "done" ИЛИ СтатусНижний = "completed" Тогда
		Возврат ?(ЕстьПросрочка, "overdue-done", "done");
	Иначе
		Возврат ?(ЕстьПросрочка, "overdue-work", "work");
	КонецЕсли;
	
КонецФункции

&НаКлиенте
Функция ВыбратьИконку(КлассСтатуса, ИконкаПауза, ИконкаВыполнено, ИконкаРаботаЧерная, ИконкаРаботаКрасная, ИконкаКрестик)
	
	Если КлассСтатуса = "pause" Тогда
		Возврат ИконкаПауза;
	ИначеЕсли КлассСтатуса = "done" Тогда
		Возврат ИконкаВыполнено;
	ИначеЕсли КлассСтатуса = "overdue-done" Тогда
		Возврат ИконкаКрестик;
	ИначеЕсли КлассСтатуса = "overdue-work" Тогда
		Возврат ИконкаРаботаКрасная;
	Иначе
		Возврат ИконкаРаботаЧерная;
	КонецЕсли;
	
КонецФункции

