#Область ОбработчикиКоманд
&НаКлиенте
Процедура ОтправитьЗапрос(Команда)
    
    // Проверяем на клиенте, что текст заполнен
    Если ПустаяСтрока(ТекстЗапроса) Тогда
        Сообщить("Введите текст обращения");
        Возврат;
    КонецЕсли;

   Если МодельИИ = ПредопределенноеЗначение("Перечисление.МоделиИИ.RuBert") Тогда 
    // Вызываем серверную процедуру
    Результат = ОтправитьЗапросИСоздатьОбращениеНаСервере(ТекстЗапроса);
	Иначе
		ОтветЗапроса = ПолучитьСообщениеGemini(ТекстЗапроса);
		Результат = Истина;
	КонецЕсли;
    
    Если Результат Тогда
        Сообщить("Обращение успешно создано!");
        ТекстЗапроса = ""; // Очищаем поле
    Иначе
        Сообщить("Не удалось создать обращение");
    КонецЕсли;
    
КонецПроцедуры
#КонецОбласти

#Область СлужебныеПроцедурыИФункции
&НаСервере
Функция ОтправитьЗапросИСоздатьОбращениеНаСервере(ТекстЗапроса)
    
    // Отправляем запрос к ML-серверу
    ОтветСервера = ОтправитьЗапросКСерверу(ТекстЗапроса);
    Если ОтветСервера = Неопределено Тогда
        Возврат Ложь;
    КонецЕсли;
    
    // Создаем обращение в базе данных
    Результат = СоздатьОбращениеВБазе(ТекстЗапроса, ОтветСервера);
    
    Возврат Результат;
    
КонецФункции

&НаСервере
Функция ОтправитьЗапросКСерверу(ТекстЗапроса)
    
    Попытка
        HTTPСоединение = Новый HTTPСоединение("localhost", 8000);
        Заголовки = Новый Соответствие;
        Заголовки.Вставить("Content-Type", "application/json");
        HTTPЗапрос = Новый HTTPЗапрос("/classify",Заголовки);
        ОтправляемаяСтруктура = Новый Структура;
        ОтправляемаяСтруктура.Вставить("text", ТекстЗапроса);
        ЗаписьJSON = Новый ЗаписьJSON;
        ЗаписьJSON.УстановитьСтроку();
        ЗаписатьJSON(ЗаписьJSON, ОтправляемаяСтруктура);
        ОтправляемаяСтрока = ЗаписьJSON.Закрыть();
        HTTPЗапрос.УстановитьТелоИзСтроки(ОтправляемаяСтрока);
        Ответ = HTTPСоединение.ОтправитьДляОбработки(HTTPЗапрос);
        ОтветЗапроса = Ответ.ПолучитьТелоКакСтроку();
        
        Возврат ОтветЗапроса;
        
    Исключение
        Сообщить("Ошибка при отправке запроса к серверу: " + ОписаниеОшибки());
        Возврат Неопределено;
    КонецПопытки;
    
КонецФункции

&НаСервере
Функция СоздатьОбращениеВБазе(ТекстЗапроса, ОтветСервера)
    
    Попытка
        // Разбор JSON ответа
        Данные = РазобратьJSONПравильно(ОтветСервера);
        Если Данные = Неопределено Тогда
            Возврат Ложь;
        КонецЕсли;

        // Создаем новое обращение
        НовоеОбращение = Справочники.Обращения.СоздатьЭлемент();

        // Заполняем основные поля
        НовоеОбращение.ТекстОбращения = ТекстЗапроса;
        
        // Заполняем тип (category)
        Категория = НРег(СокрЛП(Данные.category));
        Если Категория = "жалоба" Тогда
            НовоеОбращение.Тип = Перечисления.ТипыОбращений.Жалоба;
        ИначеЕсли Категория = "техническая ошибка" Тогда
            НовоеОбращение.Тип = Перечисления.ТипыОбращений.ТехническаяОшибка;
        ИначеЕсли Категория = "вопрос по оплате" Тогда
            НовоеОбращение.Тип = Перечисления.ТипыОбращений.ВопросПоОплате;
        ИначеЕсли Категория = "предложение" Тогда
            НовоеОбращение.Тип = Перечисления.ТипыОбращений.Предложение;
        Иначе
            НовоеОбращение.Тип = Перечисления.ТипыОбращений.Прочее;
        КонецЕсли;
        
        // Заполняем статус
        НовоеОбращение.Статус = Перечисления.СтатусыОбращения.ВРаботе;
        
        // Заполняем приоритет (priority)
        Приоритет = НРег(СокрЛП(Данные.priority));
        Если Приоритет = "высокий" Тогда
            НовоеОбращение.Приоритет = Перечисления.ПриоритетыОбращения.Высокий;
        ИначеЕсли Приоритет = "срочный" Тогда
            НовоеОбращение.Приоритет = Перечисления.ПриоритетыОбращения.Срочный;
        ИначеЕсли Приоритет = "средний" Тогда
            НовоеОбращение.Приоритет = Перечисления.ПриоритетыОбращения.Средний;
        ИначеЕсли Приоритет = "низкий" Тогда
            НовоеОбращение.Приоритет = Перечисления.ПриоритетыОбращения.Низкий;
        Иначе
            НовоеОбращение.Приоритет = Перечисления.ПриоритетыОбращения.Средний;
        КонецЕсли;
        
        // Заполняем тональность (tone)
        Тон = НРег(СокрЛП(Данные.tone));
        Если Тон = "нейтральная" Тогда
            НовоеОбращение.Тональность = Перечисления.ТональностьОбращений.Нейтральная;
        ИначеЕсли Тон = "позитивная" Тогда
            НовоеОбращение.Тональность = Перечисления.ТональностьОбращений.Позитивная;
        ИначеЕсли Тон = "негативная" Тогда
            НовоеОбращение.Тональность = Перечисления.ТональностьОбращений.Негативная;
        Иначе
            НовоеОбращение.Тональность = Перечисления.ТональностьОбращений.Нейтральная;
        КонецЕсли;
        
        // Заполняем системные поля (исправлено - убрана Дата)
        НовоеОбращение.Автор = ПользователиИнформационнойБазы.ТекущийПользователь();
        НовоеОбращение.Источник = "Обработка";
        // Дата = ТекущаяДата(); // Убрали если нет такого поля
        
        // Создаем наименование
        КороткийТекст = ТекстЗапроса;
        Если СтрДлина(КороткийТекст) > 30 Тогда
            КороткийТекст = Лев(КороткийТекст, 30) + "...";
        КонецЕсли;
        НовоеОбращение.Наименование = Данные.category + " - " + КороткийТекст;
        
        // Сохраняем
        НовоеОбращение.Записать();
        
        Сообщить("Обращение успешно создано!");
        Возврат Истина;
        
    Исключение
        Сообщить("Ошибка при создании обращения: " + ОписаниеОшибки());
        Возврат Ложь;
    КонецПопытки;
    
КонецФункции

&НаСервере
Функция РазобратьJSONПравильно(JSONСтрока)
    
    Попытка
        Сообщить("Получен ответ от сервера: " + JSONСтрока);
        
        // РУЧНОЙ РАЗБОР JSON через строковые функции
        Данные = Новый Структура;
        
        // Убираем фигурные скобки и пробелы
        JSONСтрока = СокрЛП(СтрЗаменить(JSONСтрока, "{", ""));
        JSONСтрока = СокрЛП(СтрЗаменить(JSONСтрока, "}", ""));
        
        // Разбиваем по запятым на отдельные пары "ключ:значение"
        Пары = СтрРазделить(JSONСтрока, ",");
        
        Для Каждого Пара Из Пары Цикл
            Пара = СокрЛП(Пара);
            Если Найти(Пара, ":") > 0 Тогда
                // Разбиваем на ключ и значение
                КлючИЗначение = СтрРазделить(Пара, ":");
                Если КлючИЗначение.Количество() >= 2 Тогда
                    Ключ = СокрЛП(СтрЗаменить(КлючИЗначение[0], """", ""));
                    Значение = СокрЛП(СтрЗаменить(КлючИЗначение[1], """", ""));
                    Данные.Вставить(Ключ, Значение);
                КонецЕсли;
            КонецЕсли;
        КонецЦикла;
        
        // Выводим что получили
        Сообщить("Успешно разобрано полей: " + Данные.Количество());
        Для Каждого Элемент Из Данные Цикл
            Сообщить(Элемент.Ключ + " = " + Элемент.Значение);
        КонецЦикла;
        
        Возврат Данные;
        
    Исключение
        Сообщить("Ошибка при разборе JSON: " + ОписаниеОшибки());
        Возврат Неопределено;
    КонецПопытки;
    
КонецФункции

&НаСервере
Функция ПолучитьСообщениеGemini(ТекстЗапроса)
	Возврат Интеграции.ПолучитьСообщениеGemini(ТекстЗапроса);

КонецФункции
#КонецОбласти