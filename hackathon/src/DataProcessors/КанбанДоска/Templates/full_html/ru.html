<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"><html><head><script>
  // Перетаскиваемый элемент
  let draggedItem = null;

  // Индикатор вставки (один на страницу)
  const dropIndicator = document.createElement('div');
  dropIndicator.className = 'drop-indicator';

  function onClickItem(event) {
    const eventData = { event: "ClickItem", itemId: event.currentTarget.dataset.id };
    pushEvent(eventData);
  }

  function onDragStart(event) {
    draggedItem = event.currentTarget;
    event.dataTransfer.setData("text/plain", draggedItem.dataset.id);
    // скрываем через тик, чтобы не мерцало
    setTimeout(() => { draggedItem.style.display = "none"; }, 0);
  }

  function onDragEnd(event) {
    event.currentTarget.style.display = "block";
  }

  function onDragEnter(event) {
    const category = event.currentTarget.closest('.category') || event.currentTarget;
    category.classList.add('is-over');
  }

  function onDragLeave(event) {
    const category = event.currentTarget.closest('.category') || event.currentTarget;
    if (!category.contains(event.relatedTarget)) {
      category.classList.remove('is-over');
    }
  }

  // Кто скроллит: теперь сама колонка .category
  function getScrollTarget(categoryEl) {
    return categoryEl;
  }

  // Фоллбек «прилипшей» шапки для движка IE/Trident в 1С
  function initStickyHeadersFallback() {
    var categories = document.querySelectorAll('.category');
    for (var i = 0; i < categories.length; i++) {
      (function (cat) {
        var header = cat.querySelector('.category-header');
        if (!header) return;

        header.style.transform = 'translateY(0)';

        var ticking = false;
        function onScroll() {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(function () {
            var st = cat.scrollTop || 0;
            if (st > 0) {
              header.classList.add('pinned');
              header.style.transform = 'translateY(' + st + 'px)';
            } else {
              header.classList.remove('pinned');
              header.style.transform = 'translateY(0)';
            }
            ticking = false;
          });
        }

        // Без options-объекта для совместимости
        cat.addEventListener('scroll', onScroll, false);
        window.addEventListener('resize', onScroll, false);
        onScroll();
      })(categories[i]);
    }
  }

  function onDragOver(event) {
    event.preventDefault();

    const categoryEl = event.currentTarget.closest('.category') || event.currentTarget;
    const container = categoryEl.querySelector('.items-container');
    if (!container) return;

    // Автопрокрутка именно колонки
    const scrollEl = getScrollTarget(categoryEl);
    const rect = scrollEl.getBoundingClientRect();
    const threshold = 40;
    if (event.clientY - rect.top < threshold) {
      scrollEl.scrollTop -= 12;
    } else if (rect.bottom - event.clientY < threshold) {
      scrollEl.scrollTop += 12;
    }

    // Позиционирование индикатора вставки относительно контейнера задач
    const items = Array.prototype.slice.call(container.querySelectorAll('.item'))
      .filter(function (el) { return el.style.display !== 'none'; });

    const mouseY = event.clientY;
    let placed = false;

    for (let i = 0; i < items.length; i++) {
      const r = items[i].getBoundingClientRect();
      if (mouseY < r.top + r.height / 2) {
        if (items[i].previousSibling !== dropIndicator) {
          container.insertBefore(dropIndicator, items[i]);
        }
        placed = true;
        break;
      }
    }

    if (!placed) {
      const loadMoreButton = container.querySelector('.load-more-button');
      if (loadMoreButton) container.insertBefore(dropIndicator, loadMoreButton);
      else container.appendChild(dropIndicator);
    }
  }

  function onDrop(event) {
    event.preventDefault();

    const categoryEl = event.currentTarget.closest('.category') || event.currentTarget;
    const container = categoryEl.querySelector('.items-container');
    if (!container || !draggedItem) return;

    const itemId = event.dataTransfer.getData("text/plain");
    const categoryId = categoryEl.dataset.categoryId;

    // Вставляем по индикатору
    if (dropIndicator.parentElement === container) {
      container.insertBefore(draggedItem, dropIndicator);
    } else {
      const loadMoreButton = container.querySelector('.load-more-button');
      if (loadMoreButton) container.insertBefore(draggedItem, loadMoreButton);
      else container.appendChild(draggedItem);
    }

    dropIndicator.remove();
    draggedItem.style.display = "block";
    draggedItem = null;

    categoryEl.classList.remove('is-over');

    const eventData = { event: "DropItem", itemId, categoryId };
    pushEvent(eventData);
  }

  /* Очередь событий — как у вас */
  var queue = Array();
  var queueHead = -1;
  var queueTail = -1;
  var totalEventCount = 0;

  function pushEvent(dataEvent) {
    if (queueHead === queueTail && queueHead > -1) {
      queueHead = queueTail = -1;
    }
    queue[queueTail + 1] = JSON.stringify(dataEvent);
    queueTail += 1;
    totalEventCount += 1;
    // console.log("Добавлено событие:", dataEvent);
  }

  function getEvent(index) {
    return queue[index];
  }

  function onLoadMoreClick(buttonElement) {
    const categoryElement = buttonElement.closest('.category');
    const categoryId = categoryElement.dataset.categoryId;
    const eventData = { event: "LoadMore", categoryId };
    pushEvent(eventData);
  }

  // ВАЖНО: инициализируем «прилипшие» шапки после отрисовки DOM
  document.addEventListener('DOMContentLoaded', function () {
    initStickyHeadersFallback();
  });
</script></head></html>